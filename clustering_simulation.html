<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاكاة التجميع (Clustering)</title>
    
    <!-- جلب الخطوط -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #2a303c;
            --card-dark: #364152;
            --text-light: #e5e7eb;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
            --accent-yellow: #f59e0b; /* لون أصفر مميز للتجميع */
            --cluster1: #ef4444; /* أحمر للمجموعة 1 */
            --cluster2: #10b981; /* أخضر للمجموعة 2 */
            --cluster3: #3b82f6; /* أزرق للمجموعة 3 */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Tajawal', 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            box-sizing: border-box;
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-yellow);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin-bottom: 2rem;
        }

        .back-button:hover {
            background-color: rgba(245, 158, 11, 0.1);
        }
        .back-button svg {
            width: 1.25rem;
            height: 1.25rem;
        }


        .dashboard-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background-color: var(--card-dark);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--accent-yellow);
            border-bottom: 3px solid var(--accent-yellow);
            padding-bottom: 10px;
        }
        
        .simulation-area {
            padding: 1.5rem;
            background-color: #3e4a5e;
            border-radius: 0.75rem;
        }

        #visualizationCanvas {
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
            border: 2px solid var(--border-color);
            width: 100%;
            height: 400px;
            margin-top: 1.5rem;
            touch-action: manipulation; /* تحسين استجابة اللمس */
        }

        #runClustering {
            background-color: var(--accent-yellow);
            color: var(--bg-dark);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        #runClustering:hover {
            background-color: #d97706;
            transform: translateY(-2px);
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            border-radius: 0.5rem;
            border: 1px dashed var(--text-muted);
        }

        .stat-item strong {
            display: block;
            font-size: 1.5rem;
            color: var(--accent-yellow);
        }

        /* توضيح المجموعات */
        .cluster-legend {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.95rem;
        }
        .cluster-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }

        #legend1 .cluster-point { background-color: var(--cluster1); }
        #legend2 .cluster-point { background-color: var(--cluster2); }
        #legend3 .cluster-point { background-color: var(--cluster3); }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: none; 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-dark);
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-yellow);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--accent-yellow);
        }

        .close-btn {
            color: var(--text-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover { color: var(--text-light); }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <a href="data_analysis_visual_simulation.html" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            العودة إلى المحاكاة الرئيسية
        </a>

        <h1>محاكاة تجميع العملاء (K-Means)</h1>
        <p class="text-center text-muted mb-4">
            شاهد كيف يتم تجميع العملاء إلى 3 فئات بناءً على بيانات الشراء (المحور السيني: عدد المشتريات | المحور الصادي: متوسط قيمة الشراء).
        </p>

        <div class="simulation-area">
            <h2>تصور التجميع</h2>
            <canvas id="visualizationCanvas"></canvas>
            <button id="runClustering">إعادة تعيين وبدء التجميع</button>

            <div class="summary-stats">
                <div class="stat-item">
                    <span>إجمالي نقاط البيانات</span>
                    <strong id="totalPoints">50</strong>
                </div>
                <div class="stat-item">
                    <span>عدد المجموعات (K)</span>
                    <strong>3</strong>
                </div>
                <div class="stat-item">
                    <span>التكرارات المكتملة</span>
                    <strong id="iterationCount">0</strong>
                </div>
            </div>
            
            <div class="cluster-legend">
                <div id="legend1">المجموعة 1 <span class="cluster-point"></span></div>
                <div id="legend2">المجموعة 2 <span class="cluster-point"></span></div>
                <div id="legend3">المجموعة 3 <span class="cluster-point"></span></div>
            </div>
        </div>
        <button id="infoButton" class="btn btn-secondary" style="margin-top: 1.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
            شرح المفاهيم
        </button>
    </div>
    
    <!-- Modal for Info -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>شرح التجميع (K-Means)</h2>
                <button class="close-btn" onclick="document.getElementById('infoModal').style.display='none';">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>التجميع (Clustering):</strong> هو مهمة تعلم آلي غير خاضعة للرقابة (Unsupervised) تهدف إلى تقسيم مجموعة من نقاط البيانات إلى مجموعات (عناقيد) بحيث تكون النقاط داخل المجموعة الواحدة أكثر تشابهاً مع بعضها البعض منها إلى النقاط في المجموعات الأخرى.</p>
                <p><strong>خوارزمية K-Means:</strong> هي الخوارزمية الأكثر شيوعاً للتجميع. تعمل عن طريق تعيين كل نقطة بيانات إلى أقرب مركز مجموعة (Centroid)، ثم تحريك مراكز المجموعات بشكل متكرر حتى تستقر، مما ينتج مجموعات متجانسة.</p>
                <p><strong>طريقة الكوع (Elbow Method):</strong> تُستخدم هذه الطريقة لتحديد العدد الأمثل للمجموعات (K) عن طريق تحليل التباين (Inertia) داخل المجموعات مقابل عدد المجموعات.</p>
            </div>
        </div>
    </div>

    <script>
        // دالة يتم استدعاؤها عند تحميل النافذة لتهيئة المحاكاة
        function initClusteringSimulation() {
            // المتغيرات المحلية (يتم تعريفها باستخدام const/let داخل النطاق لتجنب التكرار)
            const canvas = document.getElementById('visualizationCanvas');
            const ctx = canvas.getContext('2d');
            const K = 3; 
            const colors = [
                getComputedStyle(document.documentElement).getPropertyValue('--cluster1').trim(), 
                getComputedStyle(document.documentElement).getPropertyValue('--cluster2').trim(), 
                getComputedStyle(document.documentElement).getPropertyValue('--cluster3').trim()
            ];
            const runClusteringButton = document.getElementById('runClustering');
            const iterationCountDisplay = document.getElementById('iterationCount');
            const infoButton = document.getElementById('infoButton');
            const infoModal = document.getElementById('infoModal');

            let points = [];
            let centroids = [];
            let animationInterval = null;
            let iterationCount = 0;
            let isAssignStep = true;
            const maxX = 100; // أقصى قيمة للمشتريات
            const maxY = 200; // أقصى قيمة للقيمة

            // دالة توليد نقاط بيانات وهمية (تمثل العملاء)
            function generateData() {
                points = [];
                // توليد 50 نقطة بشكل مجمّع لتبدو مجموعات طبيعية
                for (let i = 0; i < 50; i++) {
                    let x, y;
                    // إنشاء تجمعات واضحة
                    if (i < 15) { // مجموعة العملاء 1: إنفاق منخفض/عدد قليل
                        x = Math.random() * 20 + 10;
                        y = Math.random() * 30 + 30;
                    } else if (i < 35) { // مجموعة العملاء 2: إنفاق متوسط/عدد متوسط
                        x = Math.random() * 40 + 40;
                        y = Math.random() * 60 + 80;
                    } else { // مجموعة العملاء 3: إنفاق عالٍ/عدد كبير
                        x = Math.random() * 20 + 75;
                        y = Math.random() * 50 + 150;
                    }
                    points.push({ x: x, y: y, cluster: -1 });
                }
            }

            // دالة تهيئة مراكز المجموعات بشكل عشوائي (من داخل نطاق البيانات)
            function initializeCentroids() {
                centroids = [];
                for (let i = 0; i < K; i++) {
                    centroids.push({
                        x: Math.random() * maxX,
                        y: Math.random() * maxY,
                        color: colors[i % colors.length]
                    });
                }
            }

            // دالة حساب المسافة الإقليدية
            function distance(p1, p2) {
                return Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
            }

            // دالة تعيين النقاط إلى أقرب مركز
            function assignPoints() {
                let changed = false;
                points.forEach(point => {
                    let minDistance = Infinity;
                    let newCluster = -1;

                    centroids.forEach((centroid, index) => {
                        const d = distance(point, centroid);
                        if (d < minDistance) {
                            minDistance = d;
                            newCluster = index;
                        }
                    });

                    if (point.cluster !== newCluster) {
                        point.cluster = newCluster;
                        changed = true;
                    }
                });
                return changed;
            }

            // دالة تحديث مراكز المجموعات
            function updateCentroids() {
                const newCentroids = Array(K).fill(0).map(() => ({ sumX: 0, sumY: 0, count: 0 }));

                points.forEach(point => {
                    const clusterIndex = point.cluster;
                    if (clusterIndex !== -1) {
                        newCentroids[clusterIndex].sumX += point.x;
                        newCentroids[clusterIndex].sumY += point.y;
                        newCentroids[clusterIndex].count++;
                    }
                });

                let moved = false;
                centroids.forEach((centroid, index) => {
                    const newC = newCentroids[index];
                    if (newC.count > 0) {
                        const newX = newC.sumX / newC.count;
                        const newY = newC.sumY / newC.count;
                        
                        // التحقق من الحركة
                        if (Math.abs(newX - centroid.x) > 0.1 || Math.abs(newY - centroid.y) > 0.1) {
                            moved = true;
                        }
                        centroid.x = newX;
                        centroid.y = newY;
                    }
                });
                return moved;
            }

            // دالة الرسم الرئيسية
            function drawVisualization() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // إعداد المحاور (X: 0-100، Y: 0-200)
                const padding = 30;
                const drawAreaWidth = canvas.width - 2 * padding;
                const drawAreaHeight = canvas.height - 2 * padding;

                const scaleX = drawAreaWidth / maxX;
                const scaleY = drawAreaHeight / maxY;

                // رسم النقاط
                points.forEach(point => {
                    const displayX = padding + point.x * scaleX;
                    const displayY = canvas.height - padding - (point.y * scaleY); // قلب المحور الصادي
                    
                    ctx.beginPath();
                    ctx.arc(displayX, displayY, 5, 0, Math.PI * 2);
                    
                    ctx.fillStyle = (point.cluster !== -1 && centroids[point.cluster]) 
                                    ? centroids[point.cluster].color 
                                    : 'var(--text-muted)';
                    ctx.fill();
                });

                // رسم مراكز المجموعات (كعلامات X أو مربعات)
                centroids.forEach(centroid => {
                    const displayX = padding + centroid.x * scaleX;
                    const displayY = canvas.height - padding - (centroid.y * scaleY);
                    
                    ctx.fillStyle = centroid.color;
                    ctx.fillRect(displayX - 8, displayY - 8, 16, 16);
                    
                    // خطوط مركزية لتوضيح المركز
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(displayX - 8, displayY - 8);
                    ctx.lineTo(displayX + 8, displayY + 8);
                    ctx.moveTo(displayX + 8, displayY - 8);
                    ctx.lineTo(displayX - 8, displayY + 8);
                    ctx.stroke();
                });
                
                // رسم المحاور الأساسية (لإظهار الخلفية)
                ctx.strokeStyle = 'var(--text-muted)';
                ctx.lineWidth = 1;

                // X Axis
                ctx.beginPath();
                ctx.moveTo(padding, canvas.height - padding);
                ctx.lineTo(canvas.width - padding, canvas.height - padding);
                ctx.stroke();

                // Y Axis
                ctx.beginPath();
                ctx.moveTo(padding, canvas.height - padding);
                ctx.lineTo(padding, padding);
                ctx.stroke();
                
                // إضافة تسميات المحاور
                ctx.fillStyle = 'var(--text-light)';
                ctx.font = '12px Tajawal';
                
                // X-Axis label
                ctx.textAlign = 'center';
                ctx.fillText('عدد المشتريات', canvas.width / 2, canvas.height); 

                // Y-Axis label (using rotation for better look)
                ctx.save();
                ctx.translate(5, canvas.height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.textAlign = 'center';
                ctx.fillText('متوسط قيمة الشراء', 0, 0);
                ctx.restore();

                // تحديث عداد التكرارات
                iterationCountDisplay.textContent = iterationCount;
            }

            // دالة خطوة واحدة في خوارزمية K-Means
            function kMeansStep() {
                if (isAssignStep) {
                    // خطوة 1: تعيين النقاط لأقرب مركز (Assignment)
                    const changed = assignPoints();
                    runClusteringButton.textContent = 'جارٍ تحديث المراكز...';
                    isAssignStep = false;
                    
                    if (!changed) {
                        clearInterval(animationInterval);
                        runClusteringButton.disabled = false;
                        runClusteringButton.textContent = `التجميع اكتمل في ${iterationCount} تكرار`;
                        iterationCountDisplay.textContent = iterationCount;
                    }
                } else {
                    // خطوة 2: تحديث مراكز المجموعات (Update)
                    const moved = updateCentroids();
                    runClusteringButton.textContent = 'جارٍ تعيين النقاط...';
                    isAssignStep = true;
                    iterationCount++;
                }
                
                drawVisualization();

                if (iterationCount >= 30) { // حد أقصى للحماية من التكرار اللانهائي
                    clearInterval(animationInterval);
                    runClusteringButton.disabled = false;
                    runClusteringButton.textContent = 'إعادة تعيين وبدء التجميع';
                }
            }

            // دالة تشغيل الخوارزمية كرسوم متحركة
            function runClusteringSimulation() {
                if (animationInterval) clearInterval(animationInterval);
                
                runClusteringButton.disabled = true;
                runClusteringButton.textContent = 'جارٍ التهيئة...';
                
                generateData();
                initializeCentroids();
                iterationCount = 0;
                isAssignStep = true;

                drawVisualization();
                
                // بدء الدورة التكرارية
                animationInterval = setInterval(kMeansStep, 400); // تسريع الخطوات قليلاً
            }
            
            // دالة لتهيئة حجم الكانفاس عند التحميل وتغيير الحجم
            function setupCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = 400; // تثبيت الارتفاع
                
                // إعادة الرسم فقط إذا كانت هناك بيانات مرسومة بالفعل
                if (points.length > 0) {
                    drawVisualization();
                } else {
                    generateData(); // توليد البيانات الأولية
                    drawVisualization(); // رسمها في حالة الصفر (جميع النقاط رمادية)
                    runClusteringButton.textContent = 'اضغط لبدء التجميع (K=3)';
                }
            }
            
            // ربط الأحداث
            setupCanvas();
            runClusteringButton.addEventListener('click', runClusteringSimulation);
            infoButton.addEventListener('click', () => {
                infoModal.style.display = 'flex';
            });
            window.addEventListener('resize', setupCanvas);

            // إغلاق المودال عند النقر خارج المحتوى
            window.addEventListener('click', (event) => {
                if (event.target === infoModal) {
                    infoModal.style.display = 'none';
                }
            });
        }

        // استدعاء الدالة الرئيسية عند تحميل النافذة بالكامل
        window.onload = initClusteringSimulation;
    </script>
</body>
</html>